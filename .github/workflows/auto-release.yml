name: Auto Release

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    # Previeni loop: esegui solo per PR merged da utenti reali (non bot)
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.user.type != 'Bot' &&
      !contains(github.event.pull_request.title, '[skip-release]') &&
      !contains(github.event.pull_request.title, '[auto]')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine Version Bump and Type
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const prTitle = context.payload.pull_request.title;
            const prBody = context.payload.pull_request.body || '';
            
            // Determina il bump
            let bump = 'patch';
            if (labels.includes('major')) bump = 'major';
            else if (labels.includes('minor')) bump = 'minor';
            else if (labels.includes('patch')) bump = 'patch';
            
            // Determina il tipo di change per il changelog
            let changeType = 'Fixed';
            if (labels.includes('feature') || labels.includes('enhancement') || labels.includes('minor') || labels.includes('major')) {
              changeType = 'Added';
            } else if (labels.includes('breaking') || labels.includes('major')) {
              changeType = 'Changed';
            } else if (labels.includes('fix') || labels.includes('bug') || labels.includes('patch')) {
              changeType = 'Fixed';
            }
            
            core.setOutput('bump', bump);
            core.setOutput('changeType', changeType);
            core.setOutput('prTitle', prTitle);
            core.setOutput('prNumber', context.payload.pull_request.number);
            return bump;
          result-encoding: string

      - name: Generate New Tag
        id: tag
        uses: anothrNick/github-tag-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: ${{ steps.bump.outputs.bump }}
          WITH_V: true
          DRY_RUN: false
          PRERELEASE: false
          
      - name: Update CHANGELOG.md
        id: changelog
        run: |
          # Ottieni la data corrente
          DATE=$(date +%Y-%m-%d)
          NEW_TAG="${{ steps.tag.outputs.new_tag }}"
          CHANGE_TYPE="${{ steps.bump.outputs.changeType }}"
          PR_TITLE="${{ steps.bump.outputs.prTitle }}"
          PR_NUMBER="${{ steps.bump.outputs.prNumber }}"
          
          # Crea la nuova entry del changelog
          ENTRY="## [${NEW_TAG}] - ${DATE}\n\n### ${CHANGE_TYPE}\n\n- ${PR_TITLE} (#${PR_NUMBER})\n"
          
          # Inserisci la nuova entry dopo il titolo principale
          if [ -f CHANGELOG.md ]; then
            # Trova la prima linea vuota dopo il titolo e inserisci lÃ¬
            awk -v entry="${ENTRY}" '
              BEGIN { inserted = 0 }
              /^# Changelog/ { print; next }
              /^$/ && !inserted && NR > 2 { print ""; print entry; inserted = 1; next }
              { print }
            ' CHANGELOG.md > CHANGELOG.tmp
            mv CHANGELOG.tmp CHANGELOG.md
          else
            echo -e "# Changelog\n\n${ENTRY}" > CHANGELOG.md
          fi
          
          echo "changelog_updated=true" >> $GITHUB_OUTPUT
          
      - name: Commit CHANGELOG.md
        if: steps.changelog.outputs.changelog_updated == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG for ${{ steps.tag.outputs.new_tag }} [skip-release]" || echo "No changes to commit"
          git push origin main
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.new_tag }}
          name: Release ${{ steps.tag.outputs.new_tag }}
          body: |
            ## ${{ steps.bump.outputs.changeType }}
            
            - ${{ steps.bump.outputs.prTitle }} (#${{ steps.bump.outputs.prNumber }})
            
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.tag.outputs.tag }}...${{ steps.tag.outputs.new_tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          token: ${{ secrets.GITHUB_TOKEN }}
